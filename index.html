<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link href="hover.css" rel="stylesheet" media="all">
    <link rel="stylesheet" href="style.css">
    <title>Weather-Dashboard</title>
</head>

<body>
    <header class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1 class="display-4">Weather Dashboard</h1>
            <p class="lead">This is an interactive weather dashboard. You can look up your favorite cities' weather info
                using the search function and even see 5 day forecast for those cities. Enjoy!</p>
        </div>
    </header>

    <div class="container-fluid">
        <div class=row>
            <!-- Search History -->
            <div class="col-md-4 ">
                <div class="search-label">Search for a city :</div>
                <!-- Search bar -->
                <form class="input-group">
                    <input type="text" class="form-control" id="city" required></input>
                    <button class="btn btn-primary" type="submit" id="search">Search</button>
                </form>
                <div class="list-group shadow" id="search-cities">

                </div>
                <div class="d-md-flex justify-content-center">
                    <button class="btn btn-secondary clearBtn">Clear Button</button>
                </div>
            </div>

            <!-- Weather Info -->
            <div class="col-md-8 ">
                <div class="weather-info border tab-content">
                    <div class="city-title ">
                        <div id="city-name" style="float:left"></div>
                        <img id="icon" style="float:left"></img>
                    </div>
                    <div class="info">
                        <div id="temperature"></div>
                        <div id="humidity"></div>
                        <div id="wind-speed"></div>
                        <div class="d-flex flex-row">
                            <div id="index-label">UV Index:</div>
                            <div id="uv-index"></div>
                        </div>
                    </div>
                </div>

                <div class="forecastLabel"> 5-Day Forecast</div>
                <!-- 5 day forecast -->
                <div class="d-md-flex flex-wrap justify-content-center forecastContainer" id="5-days-forecast">
                    <div id="day2" class="p-2 hvr-float">
                        <div id="date2"></div>
                        <div id="temperature2"></div>
                        <img id="icon2"></img>
                        <div id="humidity2"></div>
                    </div>
                    <div id="day3" class="p-2 hvr-float">
                        <div id="date3"></div>
                        <div id="temperature3"></div>
                        <img id="icon3"></img>
                        <div id="humidity3"></div>
                    </div>
                    <div id="day4" class="p-2 hvr-float">
                        <div id="date4"></div>
                        <div id="temperature4"></div>
                        <img id="icon4"></img>
                        <div id="humidity4"></div>
                    </div>
                    <div id="day5" class="p-2 hvr-float">
                        <div id="date5"></div>
                        <div id="temperature5"></div>
                        <img id="icon5"></img>
                        <div id="humidity5"></div>
                    </div>
                    <div id="day6" class="p-2 hvr-float">
                        <div id="date6"></div>
                        <div id="temperature6"></div>
                        <img id="icon6"></img>
                        <div id="humidity6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- sticky footer -->
    <nav class="navbar navbar-light bg-light justify-content-center">
        <a class="navbar-brand" href="#">Developed by Ethan Lam</a>
    </nav>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script type="text/javascript">



        $(document).ready(function () {
            var pastStorage = JSON.parse(localStorage.getItem("cities"))
            var cities = ["Atlanta", "Moscow", "Seattle"]

            //Load default cities for new user, none item stored in local storage
            function loadDefaultCities() {
                for (var i = 0; i < cities.length; i++) {
                    // console.log(cities.length)
                    var newDiv = $("<button>");
                    newDiv.text(cities[i]);
                    newDiv.addClass("list-group-item hvr-shutter-out-horizontal");
                    newDiv.attr("data-name", cities[i])
                    newDiv.appendTo($("#search-cities"))
                }
            }

            //Load all the cities stored in local storage for past users
            function loadNewCities() {
                for (var i = 0; i < pastStorage.length; i++) {
                    // console.log(cities.length)
                    var newDiv = $("<button>");
                    newDiv.text(pastStorage[i]);
                    newDiv.addClass("list-group-item hvr-shutter-out-horizontal");
                    newDiv.attr("data-name", pastStorage[i]);
                    newDiv.appendTo($("#search-cities"))
                }
            }

            //Populate all data in the right dashboard
            function showWeather() {
                var nameOfTheCityClicked = ($(this).attr("data-name"));
                var weatherUrl = "http://api.openweathermap.org/data/2.5/weather?q=" + nameOfTheCityClicked + "&units=imperial&appid=4aa00dba2ffa0a80a6d24790f15d7055"
                var selectIcon = ($("#icon"))

                // console.log(weatherUrl)

                //populate the weather info
                $.ajax({
                    url: weatherUrl,
                    method: "GET"
                })
                    .then(function (response) {
                        // console.log(weatherUrl)
                        // console.log(response.main.temp)
                        //add city name
                        var localTime = moment().format("MMMM Do YYYY")
                        $("#city-name").text(nameOfTheCityClicked + " (" + localTime + ")")

                        //add temperature
                        var currentTemperature = response.main.temp;
                        $("#temperature").text("Temperature: " + currentTemperature + "\u00B0 F")

                        //add icon
                        // console.log(select)
                        var iconUrl = response.weather[0].icon
                        $(selectIcon).attr("src", "http://openweathermap.org/img/wn/" + iconUrl + "@2x.png")

                        //add humidity
                        var currentHumidity = response.main.humidity;
                        $("#humidity").text("Humidity: " + currentHumidity + "%")

                        //add wind-speed
                        var currentWindSpeed = response.wind["speed"]
                        $("#wind-speed").text("Wind speed: " + currentWindSpeed + " MPH")

                        //find longitude and latitude of current city
                        var lat = response.coord.lat;
                        var long = response.coord.lon
                        var forecastUrl = "https://api.openweathermap.org/data/2.5/onecall?lat=" + lat + "&lon=" + long + "&exclude=current,minutely,hourly&appid=4aa00dba2ffa0a80a6d24790f15d7055&units=imperial"
                        var uvIndexUrl = "http://api.openweathermap.org/data/2.5/uvi?appid=4aa00dba2ffa0a80a6d24790f15d7055&lat=" + lat + "&lon=" + long

                        // add 5day forecast
                        $.ajax({
                            url: forecastUrl,
                            method: "GET"
                        })
                            .then(function (response) {
                                console.log(forecastUrl)
                                for (var i = 2; i < 7; i++) {
                                    // console.log($("#date" + i))
                                    $("#date" + i).text(moment().add(i - 1, "days").format("MM/D/YYYY"))
                                    $("#temperature" + i).text("Temp: " + response.daily[i - 1].temp.day + "\u00B0 F")
                                    $("#humidity" + i).text("Humidity: " + response.daily[i - 1].humidity + "%")
                                    var iconUrl = response.daily[i - 1].weather[0].icon
                                    $("#icon" + i).attr("src", "http://openweathermap.org/img/wn/" + iconUrl + "@2x.png")
                                }
                            })

                        //add uv index
                        $.ajax({
                            url: uvIndexUrl,
                            method: "GET"
                        })
                            .then(function (response) {
                                // console.log(response)
                                var uvIndex = response.value
                                $("#uv-index").text(uvIndex)
                                var indexInNumber = parseInt($("#uv-index").text())
                                $("#uv-index").toggleClass("red", indexInNumber >= 8);
                                $("#uv-index").toggleClass("orange", indexInNumber <= 7 && indexInNumber > 5)
                                $("#uv-index").toggleClass("yellow", indexInNumber <= 5 && indexInNumber > 2)
                                $("#uv-index").toggleClass("green", indexInNumber <= 2)
                            })
                    })

            }

            //upon click search, save city to local storage, create new button and display on left sidebar
            $("#search").on("click", function search(event) {
                event.preventDefault();
                var desireCity = $("#city").val().trim();
                if (!desireCity) { return }
                else {
                    $("#search-cities").empty()
                    if (pastStorage === null) {
                        cities.push(desireCity);
                        localStorage.setItem("cities", JSON.stringify(cities));
                        loadDefaultCities()
                        $("#city").val("")
                    }
                    else {
                        pastStorage.push(desireCity);
                        localStorage.setItem("cities", JSON.stringify(pastStorage));
                        // console.log("not empty")
                        loadNewCities()
                        $("#city").val("")
                    }
                }
            })

            //when click on the city, do an Ajax, call, get weather info of the city based on data-name and plug into the weather dashboard
            $(document).on("click", "button[data-name]", showWeather)

            //Upon loading screen, display weather info for the last searched city
            if (pastStorage === null) {
                loadDefaultCities()
                // console.log($("#search-cities button:last-child").text())
                var lastSearch = $("#search-cities button:last-child")
                lastSearch.trigger("click")
            }
            else {
                loadNewCities()
                // console.log($("#search-cities button:last-child").text())
                var lastSearch = $("#search-cities button:last-child")
                lastSearch.trigger("click")
            }

            $(".clearBtn").click(function () {
                localStorage.clear()
                location.reload()
            })
        })

    </script>

</body>

</html>